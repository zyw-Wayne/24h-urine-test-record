---
name: 历史数据手动录入功能
overview: 在历史模块增加历史数据手动录入功能，支持录入时间、总尿量、检测指标，并支持编辑已录入的数据。新增'manual'状态用于标识手动录入的记录。
todos:
  - id: update_types
    content: 更新类型定义，在CycleStatus中添加'manual'状态
    status: completed
  - id: add_ui_button
    content: 在历史页面时间筛选卡片中添加"添加历史记录"按钮
    status: completed
  - id: create_form_modal
    content: 创建录入/编辑表单弹窗，包含时间、总尿量、所有检测指标字段
    status: completed
  - id: implement_auto_calc
    content: 实现24小时总蛋白量自动计算逻辑（可选，可手动覆盖）
    status: completed
  - id: implement_save_logic
    content: 实现保存逻辑：新增和编辑模式的处理
    status: completed
  - id: update_list_display
    content: 在历史列表中标识手动录入的记录，支持点击编辑
    status: completed
  - id: test_functionality
    content: 测试新增、编辑、列表显示等功能
    status: completed
---

# 历史数据手动录入功能实现方案

## 需求分析

在历史模块增加手动录入历史数据的功能，允许用户：
1. 录入检测周期的开始时间
2. 录入总尿量
3. 录入所有检测指标（与Record页面相同）
4. 24小时总蛋白量可选：可手动输入或根据公式自动计算
5. 支持编辑已录入的历史数据
6. 手动录入的记录状态为'manual'，与正常记录区分

## 实现方案

### 1. 更新类型定义

**文件**: `src/types/index.ts`

- 更新 `CycleStatus` 类型，添加 `'manual'` 状态
- 确保 `TestCycle` 接口支持手动录入的场景（urinationRecords 可以为空数组）

```typescript
export type CycleStatus = 'ongoing' | 'completed' | 'manual'
```

### 2. 历史页面UI增强

**文件**: `src/pages/History/index.tsx`

**新增功能**：
- 在时间筛选卡片中添加"添加历史记录"按钮
- 添加录入/编辑表单弹窗状态管理
- 在历史列表中标识手动录入的记录（显示"手动录入"标签）

**UI布局**：
```
[时间筛选卡片]
  - 时间筛选按钮（最近三个月/半年/全部）
  - 查看图表按钮
  - 添加历史记录按钮（新增）⭐

[历史记录列表]
  - 每条记录显示"手动录入"标签（如果是manual状态）⭐
  - 点击记录可以编辑（如果是manual状态）⭐
```

### 3. 录入/编辑表单组件

**文件**: `src/pages/History/index.tsx`

**表单字段**：
1. **开始时间**（DatePicker，必填）
   - 默认当前时间，可手动调整
   - 格式：YYYY-MM-DD HH:mm

2. **总尿量**（Input，必填）
   - 单位：ml
   - 验证：必须大于0

3. **24H尿蛋白定量**（Input，必填）
   - 单位：mg/L
   - 验证：必须≥0

4. **24小时总蛋白量**（Input，可选）
   - 单位：g
   - 两种模式：
     - 自动计算：当输入24H尿蛋白定量和总尿量后，自动计算
     - 手动输入：可以手动覆盖自动计算的值
   - 显示计算按钮："自动计算"按钮，点击后根据公式计算

5. **尿常规-尿蛋白**（Selector，可选）
   - 选项：阴性(-)、弱阳性(±)、1+、2+、3+、4+、++、+++、++++

6. **尿常规-潜血**（Selector，可选）
   - 选项：同上

7. **肌酐**（Input，必填）
   - 单位：μmol/L
   - 验证：必须≥0

8. **尿比重**（Input，必填）
   - 验证：1.000-1.050

9. **pH值**（Input，必填）
   - 验证：0-14

**表单逻辑**：
- 当编辑模式时，表单初始值填充现有数据
- 24小时总蛋白量自动计算逻辑：
  - 监听24H尿蛋白定量和总尿量的变化
  - 当两者都有值时，自动计算并填充到24小时总蛋白量字段
  - 用户可以手动修改计算结果
- 保存时：
  - 如果24小时总蛋白量为空，使用自动计算的值
  - 创建新记录时，status设为'manual'，urinationRecords为空数组
  - 更新记录时，保持原有ID和创建时间

### 4. 数据保存逻辑

**文件**: `src/pages/History/index.tsx`

**新增函数**：
- `handleAddManualRecord()`: 打开新增表单
- `handleEditManualRecord(cycle)`: 打开编辑表单
- `handleSaveManualRecord(values)`: 保存手动录入的数据
  - 判断是新增还是编辑模式
  - 计算24小时总蛋白量（如果未手动输入）
  - 调用 `cycleService.create()` 或 `cycleService.update()`
  - 刷新列表

**数据格式**：
```typescript
{
  startTime: string, // ISO格式
  endTime: string, // 可选，可以设为startTime + 24小时
  status: 'manual',
  totalVolume: number,
  urinationRecords: [], // 空数组
  testResults: {
    protein24hQuantitative: number,
    proteinTotal24h: number, // 手动输入或自动计算
    proteinRoutine?: string,
    occultBlood?: string,
    creatinine: number,
    specificGravity: number,
    ph: number,
    testedAt: string, // 检测时间，可以设为startTime
  }
}
```

### 5. 列表显示优化

**文件**: `src/pages/History/index.tsx`

**显示逻辑**：
- 在列表项中，如果 `cycle.status === 'manual'`，显示"手动录入"标签
- 点击手动录入的记录，打开编辑表单（而不是详情弹窗）
- 正常记录（ongoing/completed）点击仍显示详情弹窗

### 6. 详情页面适配

**文件**: `src/pages/History/Detail.tsx`

- 检查是否需要适配手动录入的记录显示
- 手动录入的记录没有排尿记录，详情页面需要处理空数组情况（应该已经支持）

## 实现细节

### 表单自动计算逻辑

```typescript
// 监听24H尿蛋白定量和总尿量的变化
useEffect(() => {
  const protein24h = form.getFieldValue('protein24hQuantitative')
  const totalVolume = form.getFieldValue('totalVolume')
  
  if (protein24h && totalVolume && !manualProteinTotal) {
    const calculated = calculateProteinTotal24h(protein24h, totalVolume)
    form.setFieldsValue({ proteinTotal24h: calculated })
  }
}, [protein24hQuantitative, totalVolume, manualProteinTotal])
```

### 编辑模式判断

- 使用 `editingCycle` 状态存储正在编辑的记录
- 如果 `editingCycle` 不为null，则为编辑模式
- 编辑模式下，表单初始值从 `editingCycle` 获取

### 状态管理

```typescript
const [manualFormVisible, setManualFormVisible] = useState(false)
const [editingCycle, setEditingCycle] = useState<TestCycle | null>(null)
const [manualForm] = Form.useForm()
```

## 文件修改清单

1. **src/types/index.ts**
   - 更新 `CycleStatus` 类型

2. **src/pages/History/index.tsx**
   - 添加"添加历史记录"按钮
   - 添加录入/编辑表单弹窗
   - 实现保存逻辑
   - 优化列表显示（标识手动录入）
   - 支持点击编辑

3. **src/pages/History/Detail.tsx**（可选）
   - 检查是否需要适配手动录入记录显示

## 测试要点

1. 新增手动录入记录
   - 填写所有必填字段
   - 验证自动计算24小时总蛋白量
   - 验证手动覆盖计算结果
   - 验证保存后列表刷新

2. 编辑手动录入记录
   - 点击手动录入的记录
   - 验证表单初始值正确
   - 修改后保存
   - 验证更新成功

3. 列表显示
   - 验证手动录入记录显示"手动录入"标签
   - 验证正常记录不受影响
   - 验证时间筛选正常工作

4. 数据验证
   - 验证必填字段
   - 验证数值范围
   - 验证计算公式正确性

## 注意事项

1. 手动录入的记录 `urinationRecords` 为空数组，在详情页面和统计中需要处理
2. 24小时总蛋白量的自动计算是可选的，用户可以手动输入
3. 编辑时保持原有记录的ID和创建时间，只更新相关字段
4. 手动录入的记录在图表中也会显示，与其他记录一起展示趋势