# 24小时尿蛋白检测记录系统

一个用于记录和管理24小时尿蛋白检测数据的H5移动端应用。帮助用户便捷地记录24小时尿液收集过程，录入检测指标，并追踪历史数据趋势。

## 功能特性

### 核心功能

- **检测周期管理**：开始和结束24小时检测周期，实时显示剩余时间倒计时和进度条
- **排尿记录**：记录每次排尿的时间和尿量，自动计算总尿量，支持删除记录
- **检测指标记录**：记录24H尿蛋白定量、尿常规-尿蛋白、尿常规-潜血、肌酐、尿比重、pH值等指标
- **自动计算**：自动计算24小时总尿蛋白量（公式：蛋白浓度(mg/L) × 总尿量(ml) / 1000 / 1000 = 总蛋白(g)）
- **异常值提示**：根据用户性别自动判断正常值范围，超出正常范围的指标会红色高亮显示
- **智能提醒**：开始新周期前会检查上一个周期是否已录入检测结果，提供相应提示

### 历史记录

- **历史查询**：查看所有历史检测记录，按时间倒序排列
- **记录详情**：查看每个检测周期的完整信息（周期信息、检测结果、所有排尿记录）
- **数据可视化**：通过折线图和柱状图展示多个指标的趋势变化
  - 24H尿蛋白定量趋势
  - 尿常规-尿蛋白趋势
  - 尿常规-潜血趋势
  - 肌酐趋势
  - 多指标对比图表
- **时间筛选**：支持按最近3个月、6个月或全部筛选历史记录
- **记录删除**：支持删除单条历史记录（需确认，不可恢复）

### 数据管理

- **Excel导出**：导出所有历史记录为Excel文件，包含周期信息、检测结果和排尿记录详情
- **数据备份**：备份所有数据为JSON文件，包含检测周期、排尿记录和用户配置
- **数据恢复**：从备份文件恢复数据，支持跨设备数据迁移
- **数据清空**：清空所有数据（需二次确认，防止误操作）

### 用户设置

- **个人信息**：设置昵称、性别、年龄（性别用于判断肌酐正常值范围）
- **单位设置**：自定义尿量单位（ml/L）和蛋白单位（mg/g）
- **主题设置**：支持浅色/深色主题切换
- **使用说明**：内置检测流程、注意事项和正常值参考说明

## 技术栈

- **前端框架**：React 18.3.1 + TypeScript 5.5.4
- **UI框架**：Ant Design Mobile 5.37.0
- **数据存储**：IndexedDB (使用Dexie.js 3.2.4)
- **数据可视化**：Chart.js 4.4.4 + react-chartjs-2 5.2.0
- **日期处理**：dayjs 1.11.13
- **Excel导出**：xlsx 0.18.5 + file-saver 2.0.5
- **构建工具**：Vite 5.4.2
- **路由管理**：React Router 6.26.0
- **代码规范**：ESLint 8.57.0 + Prettier 3.3.3

## 安装和运行

### 环境要求

- Node.js >= 16.0.0
- npm >= 7.0.0

### 安装依赖

```bash
npm install
```

### 开发模式

```bash
npm run dev
```

应用将在 `http://localhost:3000` 启动（自动打开浏览器）

### 构建生产版本

```bash
npm run build
```

构建产物在 `dist` 目录

### 预览生产版本

```bash
npm run preview
```

## 使用说明

### 开始检测

1. 打开应用，进入"记录"页面
2. 点击"开始检测周期"按钮
3. 系统会自动记录开始时间，并开始24小时倒计时

### 记录排尿

1. 每次排尿后，点击"添加记录"按钮
2. 选择排尿时间（默认当前时间，可手动调整）
3. 输入尿量（毫升）
4. 点击"保存"

### 录入检测结果

1. 在检测周期进行中或结束后，点击"检测结果"卡片右上角的"录入"或"编辑"按钮
2. 输入各项检测指标：
   - 24H尿蛋白定量（mg/L，必填）
   - 尿常规-尿蛋白（可选：阴性(-)、弱阳性(±)、1+、2+、3+、4+、++、+++、++++）
   - 尿常规-潜血（可选：阴性(-)、弱阳性(±)、1+、2+、3+、4+、++、+++、++++）
   - 肌酐（μmol/L，必填）
   - 尿比重（必填，范围1.000-1.050）
   - pH值（必填，范围0-14）
3. 系统会自动计算24小时总尿蛋白量（g）
4. 点击"保存"

### 查看历史记录

1. 进入"历史"页面
2. 可以按时间范围筛选（最近3个月/6个月/全部）
3. 点击记录查看详情
4. 点击"查看图表"查看数据可视化
5. 可以删除不需要的历史记录

### 数据导出和备份

1. 进入"我的"页面
2. 点击"导出Excel"导出所有记录为Excel文件
3. 点击"备份数据"下载JSON格式的备份文件
4. 点击"恢复数据"从备份文件恢复数据

## 正常值参考

- **24小时尿蛋白**：< 150 mg（男女通用）
- **肌酐**：
  - 男性：53-106 μmol/L
  - 女性：44-97 μmol/L
- **尿比重**：1.003-1.030（男女通用）
- **pH值**：4.6-8.0（男女通用）

> 注意：系统会根据您在"我的"页面设置的性别，自动使用对应的正常值范围来判断检测结果是否异常。

## 注意事项

1. **首次排尿不收集**：开始检测后，首次排尿不收集，之后的所有尿液都需收集
2. **完整收集**：确保24小时内所有尿液都收集完整，避免遗漏
3. **冷藏保存**：尿液需冷藏保存，避免细菌污染
4. **避免干扰**：检测期间避免剧烈运动、高蛋白饮食和服用可能影响结果的药物
5. **数据备份**：建议定期备份数据，防止数据丢失

## 浏览器兼容性

- iOS Safari 12+
- Android Chrome 80+
- 微信内置浏览器
- 其他现代浏览器

## 项目结构

```
24h-urine-test-record/
├── public/                 # 静态资源
│   └── vite.svg           # 图标文件
├── src/
│   ├── components/        # 公共组件
│   │   ├── Layout/        # 布局组件（底部导航栏）
│   │   └── Common/        # 通用组件
│   │       ├── EmptyState.tsx    # 空状态组件
│   │       ├── ErrorBoundary.tsx # 错误边界
│   │       └── Loading.tsx       # 加载组件
│   ├── pages/             # 页面组件
│   │   ├── Record/        # 记录页
│   │   │   └── index.tsx  # 检测周期管理和记录录入
│   │   ├── History/       # 历史页
│   │   │   ├── index.tsx  # 历史记录列表
│   │   │   ├── Detail.tsx  # 记录详情
│   │   │   └── Chart.tsx   # 数据可视化图表
│   │   └── Profile/        # 我的页
│   │       └── index.tsx  # 用户设置和数据管理
│   ├── services/          # 服务层
│   │   ├── db.ts          # IndexedDB数据库操作
│   │   ├── export.ts      # Excel导出功能
│   │   └── backup.ts      # 数据备份和恢复
│   ├── utils/             # 工具函数
│   │   ├── index.ts       # 通用工具函数
│   │   └── normalRanges.ts # 正常值范围计算
│   ├── types/             # TypeScript类型定义
│   │   └── index.ts       # 所有类型定义
│   ├── constants/         # 常量定义
│   │   └── index.ts       # 应用常量
│   ├── App.tsx            # 根组件（路由配置）
│   ├── main.tsx           # 入口文件
│   └── index.css          # 全局样式
├── .eslintrc.cjs          # ESLint配置
├── .prettierrc            # Prettier配置
├── .gitignore             # Git忽略文件
├── package.json           # 项目依赖配置
├── tsconfig.json          # TypeScript配置
├── tsconfig.node.json     # Node环境TS配置
├── vite.config.ts         # Vite构建配置
├── index.html             # HTML入口
├── LICENSE                # 许可证文件
└── README.md              # 项目说明文档
```

## 开发说明

### 代码规范

- 使用ESLint进行代码检查
- 使用Prettier进行代码格式化
- 所有AI生成的代码都标记了 `

### 数据模型

主要数据模型包括：

- **TestCycle（检测周期）**
  - `id`: 唯一标识（自动生成）
  - `startTime`: 开始时间（ISO 8601格式）
  - `endTime`: 结束时间（可选，ISO 8601格式）
  - `status`: 状态（'ongoing' | 'completed'）
  - `totalVolume`: 总尿量（ml，自动累加）
  - `urinationRecords`: 排尿记录数组（关联查询）
  - `testResults`: 检测结果（可选）
  - `createdAt`: 创建时间（ISO 8601格式）
  - `updatedAt`: 更新时间（ISO 8601格式）

- **UrinationRecord（排尿记录）**
  - `id`: 唯一标识（自动生成）
  - `cycleId`: 所属检测周期ID（外键）
  - `time`: 排尿时间（ISO 8601格式）
  - `volume`: 尿量（ml，必须大于0）
  - `createdAt`: 创建时间（ISO 8601格式）

- **TestResult（检测结果）**
  - `protein24hQuantitative`: 24H尿蛋白定量（mg/L，必填，≥0）
  - `proteinTotal24h`: 24h总蛋白（g，自动计算）
  - `proteinRoutine`: 尿常规-尿蛋白（可选：阴性(-)、弱阳性(±)、1+、2+、3+、4+、++、+++、++++）
  - `occultBlood`: 尿常规-潜血（可选：阴性(-)、弱阳性(±)、1+、2+、3+、4+、++、+++、++++）
  - `creatinine`: 肌酐（μmol/L，必填，≥0）
  - `specificGravity`: 尿比重（必填，范围1.000-1.050）
  - `ph`: pH值（必填，范围0-14）
  - `testedAt`: 检测时间（ISO 8601格式）

- **UserConfig（用户配置）**
  - `nickname`: 昵称（必填）
  - `gender`: 性别（'male' | 'female'，可选，用于判断肌酐正常值范围）
  - `age`: 年龄（可选，数字）
  - `unit`: 单位设置
    - `volume`: 尿量单位（'ml' | 'l'，默认'ml'）
    - `protein`: 蛋白单位（'mg' | 'g'，默认'mg'）
  - `theme`: 主题（'light' | 'dark'，默认'light'）

- **BackupData（备份数据）**
  - `version`: 备份版本号（当前为'1.0.0'）
  - `exportTime`: 导出时间（ISO 8601格式）
  - `testCycles`: 所有检测周期（完整数据）
  - `userConfig`: 用户配置

### 数据存储

- 使用IndexedDB存储所有数据，数据库名称为 `UrineTestDB`，版本为1
- 使用Dexie.js简化数据库操作，提供类型安全的API
- 所有数据存储在本地浏览器，不上传服务器，完全保护用户隐私
- 支持数据备份为JSON文件，可跨设备恢复（包含完整数据结构和时间戳）
- 支持导出Excel格式，方便医生查看和分析（包含周期信息、检测结果和排尿记录详情）
- 数据库索引：
  - `testCycles`: id, startTime, status, createdAt
  - `urinationRecords`: id, cycleId, time, createdAt
  - `userConfig`: id（固定为'default'）

### 核心功能逻辑

1. **检测周期管理**
   - 同一时间只能有一个进行中的检测周期（status='ongoing'）
   - 开始新周期前会检查上一个周期是否已录入检测结果：
     - 如果已录入：提示确认后开始新周期
     - 如果未录入：提示先录入检测结果，或选择跳过（需二次确认）
   - 周期结束后仍可录入/编辑检测结果，但不能再添加或删除排尿记录
   - 实时显示剩余时间倒计时（每秒更新）和进度条

2. **自动计算**
   - 24小时总尿蛋白量计算公式：`(24H尿蛋白定量 mg/L × 总尿量 ml) / 1000 / 1000 = 总蛋白 g`
   - 总尿量自动累加所有排尿记录的尿量（添加/删除/更新记录时自动重新计算）
   - 平均每次尿量 = 总尿量 / 排尿次数

3. **异常值判断**
   - 根据用户设置的性别，使用对应的肌酐正常值范围：
     - 男性：53-106 μmol/L
     - 女性：44-97 μmol/L（默认，更保守）
   - 其他指标正常值范围（男女通用）：
     - 24小时尿蛋白：< 150 mg
     - 尿比重：1.003-1.030
     - pH值：4.6-8.0
   - 超出正常范围的指标会以红色高亮显示

4. **数据可视化**
   - 支持多个指标的折线图和柱状图展示
   - 折线图：24H尿蛋白定量、肌酐、总尿量趋势
   - 柱状图：尿常规-尿蛋白、尿常规-潜血、多指标对比
   - 图表支持时间筛选（最近3个月/6个月/全部）
   - 尿常规值转换为数值用于图表显示（阴性=0，弱阳性=0.5，1+/++=1，2+/+++=2，3+/++++=3，4+=4）

5. **数据完整性**
   - 添加排尿记录时自动更新周期的总尿量
   - 删除排尿记录时自动重新计算总尿量
   - 备份恢复时保留原始ID和时间戳，确保数据一致性

## 许可证

MIT License

## 开发命令

```bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 构建生产版本
npm run build

# 预览生产版本
npm run preview

# 代码检查
npm run lint

# 代码格式化
npm run format
```

## 注意事项

### 开发注意事项

1. 所有AI生成的代码都标记了 `
2. 使用TypeScript严格模式，确保类型安全
3. 遵循React Hooks最佳实践，合理使用useState、useEffect等
4. 使用Ant Design Mobile组件库，保持UI一致性和移动端体验
5. 数据操作都通过service层（`src/services/`），保持代码结构清晰
6. 使用路径别名 `@/` 指向 `src/` 目录，简化导入路径
7. 错误处理：使用ErrorBoundary捕获React组件错误，使用Toast显示操作反馈
8. 表单验证：使用Ant Design Mobile的Form组件进行表单验证
9. 数据持久化：所有数据操作都是异步的，使用async/await处理
10. 性能优化：使用React.memo、useMemo等优化渲染性能

### 数据安全

1. 所有数据存储在本地IndexedDB，不会上传到服务器
2. 建议用户定期备份数据，防止浏览器数据被清除
3. 备份文件为JSON格式，包含所有检测记录和用户配置

## 版本历史

### v1.0.0 (当前版本)

- 初始版本
- ✅ 实现核心功能：检测周期管理、排尿记录、检测指标录入
- ✅ 实现历史记录查询和数据可视化
- ✅ 实现数据导出（Excel）、备份和恢复功能
- ✅ 实现用户设置和配置（个人信息、单位、主题）
- ✅ 支持异常值高亮提示（根据性别判断正常值范围）
- ✅ 支持多指标数据可视化（折线图、柱状图）
- ✅ 支持时间筛选（最近3个月/6个月/全部）
- ✅ 支持实时倒计时和进度条显示
- ✅ 支持智能提醒（开始新周期前检查上一周期状态）

## 贡献指南

欢迎提交Issue和Pull Request来帮助改进项目。

## 许可证

MIT License
